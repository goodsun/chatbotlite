<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatBot Lite</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #0a0a1a;
  color: #e0e0e0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  padding: 10px 20px;
  background: #12101f;
  border-bottom: 1px solid #2a1a3a;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.header h1 {
  font-size: 1.1rem;
  background: linear-gradient(135deg, #b366ff, #ffd700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  white-space: nowrap;
}

.header .api-group {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: auto;
}

.header input[type="password"],
.header input[type="text"] {
  width: 200px;
  padding: 6px 10px;
  background: #1a1a2a;
  border: 1px solid #3a2a5a;
  border-radius: 6px;
  color: #e0d0f0;
  font-size: 0.8rem;
  font-family: monospace;
}

.header input:focus { outline: none; border-color: #b366ff; }

.header button {
  padding: 6px 8px;
  background: none;
  border: 1px solid #3a2a5a;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
}

.header label {
  font-size: 0.7rem;
  color: #6a5a8a;
  display: flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  white-space: nowrap;
}

.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.msg {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 0.9rem;
  line-height: 1.6;
  word-wrap: break-word;
}

.msg.user {
  align-self: flex-end;
  background: #4f46e5;
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg.bot {
  align-self: flex-start;
  background: #1e1e3a;
  color: #e0e0e0;
  border-bottom-left-radius: 4px;
}

.msg.bot a { color: #b366ff; }
.msg.bot code { background: #2a2a4a; padding: 2px 5px; border-radius: 3px; font-size: 0.85em; }
.msg.bot pre { background: #2a2a4a; padding: 8px 10px; border-radius: 6px; overflow-x: auto; margin: 6px 0; font-size: 0.8rem; }
.msg.bot ul, .msg.bot ol { padding-left: 1.2em; margin: 4px 0; }
.msg.bot blockquote { border-left: 3px solid #b366ff; padding-left: 10px; margin: 4px 0; opacity: 0.85; }
.msg.bot p { margin: 4px 0; }
.msg.bot p:first-child { margin-top: 0; }
.msg.bot p:last-child { margin-bottom: 0; }

.msg.system {
  align-self: center;
  background: none;
  color: #6a5a8a;
  font-size: 0.8rem;
  text-align: center;
}

.typing {
  align-self: flex-start;
  color: #6a5a8a;
  font-size: 0.85rem;
  padding: 8px 14px;
}

.typing::after {
  content: '...';
  animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
  0%, 20% { content: ''; }
  40% { content: '.'; }
  60% { content: '..'; }
  80%, 100% { content: '...'; }
}

.input-area {
  padding: 12px 20px;
  background: #12101f;
  border-top: 1px solid #2a1a3a;
  display: flex;
  gap: 8px;
}

.input-area textarea {
  flex: 1;
  padding: 10px 14px;
  background: #1a1a2a;
  border: 1px solid #3a2a5a;
  border-radius: 12px;
  color: #e0d0f0;
  font-size: 0.9rem;
  font-family: inherit;
  resize: none;
  rows: 1;
  max-height: 120px;
  line-height: 1.4;
}

.input-area textarea:focus { outline: none; border-color: #b366ff; }

.input-area button {
  padding: 10px 20px;
  background: linear-gradient(135deg, #b366ff, #7c3aed);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s;
  white-space: nowrap;
}

.input-area button:hover { opacity: 0.85; }
.input-area button:disabled { opacity: 0.4; cursor: not-allowed; }

.welcome {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: #6a5a8a;
  text-align: center;
  padding: 40px;
}

.welcome h2 {
  font-size: 1.5rem;
  background: linear-gradient(135deg, #b366ff, #ffd700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.welcome p { font-size: 0.9rem; max-width: 400px; line-height: 1.6; }

/* Config panel */
.config-toggle {
  color: #6a5a8a;
  font-size: 0.75rem;
  cursor: pointer;
  text-decoration: underline;
  white-space: nowrap;
}

.config-panel {
  display: none;
  width: 100%;
  padding: 10px 20px;
  background: #0f0f1f;
  border-bottom: 1px solid #2a1a3a;
}

.config-panel.active { display: block; }

.config-panel textarea {
  width: 100%;
  height: 120px;
  padding: 10px;
  background: #1a1a2a;
  border: 1px solid #3a2a5a;
  border-radius: 8px;
  color: #e0d0f0;
  font-size: 0.8rem;
  font-family: monospace;
  resize: vertical;
  line-height: 1.5;
}

.config-panel textarea:focus { outline: none; border-color: #b366ff; }

.config-panel label {
  display: block;
  font-size: 0.75rem;
  color: #8a7aaa;
  margin-bottom: 4px;
}

.config-row {
  display: flex;
  gap: 12px;
  margin-top: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.config-row select, .config-row input {
  padding: 4px 8px;
  background: #1a1a2a;
  border: 1px solid #3a2a5a;
  border-radius: 6px;
  color: #e0d0f0;
  font-size: 0.8rem;
}

.config-row label {
  display: inline;
  font-size: 0.75rem;
  color: #8a7aaa;
  margin-bottom: 0;
}

@media (max-width: 600px) {
  .header { gap: 8px; }
  .header .api-group { width: 100%; margin-left: 0; }
  .header input[type="password"], .header input[type="text"] { flex: 1; width: auto; }
  .msg { max-width: 90%; }
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ’¬ ChatBot Lite</h1>
  <span class="config-toggle" id="configToggle">âš™ï¸ Settings</span>
  <div class="api-group">
    <input type="password" id="apiKey" placeholder="Gemini API Key">
    <button id="keyVisBtn" title="Show/Hide">ğŸ‘</button>
    <label><input type="checkbox" id="rememberCb"> Remember</label>
  </div>
</div>

<div class="config-panel" id="configPanel">
  <label>System Prompt (ã“ã®å­ã®æ€§æ ¼ãƒ»çŸ¥è­˜ã‚’å®šç¾©)</label>
  <textarea id="systemPrompt">ã‚ãªãŸã¯è¦ªåˆ‡ã§çŸ¥çš„ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ—¥æœ¬èªã§ä¸å¯§ã«ãŠç­”ãˆãã ã•ã„ã€‚</textarea>
  <div class="config-row">
    <label>Model:
      <select id="modelSelect">
        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
        <option value="gemini-1.5-pro">gemini-1.5-pro</option>
      </select>
    </label>
    <label>Title: <input type="text" id="botTitle" value="ChatBot Lite" style="width:150px;"></label>
    <button id="clearMemory" style="padding:4px 10px; background:#dc2626; color:#fff; border:none; border-radius:6px; font-size:0.75rem; cursor:pointer;">ğŸ—‘ è¨˜æ†¶ã‚¯ãƒªã‚¢</button>
    <button id="clearHistory" style="padding:4px 10px; background:#6b7280; color:#fff; border:none; border-radius:6px; font-size:0.75rem; cursor:pointer;">ğŸ—‘ å±¥æ­´ã‚¯ãƒªã‚¢</button>
  </div>
  <div id="memoryPreview" style="margin-top:8px; font-size:0.7rem; color:#6a5a8a; max-height:60px; overflow-y:auto;"></div>
</div>

<div class="chat-area" id="chatArea">
  <div class="welcome" id="welcome">
    <img id="welcomeImg" src="images/mephi.jpg" alt="ChatBot" style="width:200px; border-radius:12px; margin-bottom:8px; opacity:0.9;">
    <h2>ğŸ’¬ ChatBot Lite</h2>
    <p>HTML1ãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ãAIãƒãƒ£ãƒƒãƒˆbotã€‚<br>Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚</p>
    <p style="font-size:0.75rem;">âš™ï¸ Settings ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†ã—ã¦ã€<br>å¥½ããªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»å°‚é–€çŸ¥è­˜ã‚’æŒãŸã›ã‚‰ã‚Œã¾ã™ã€‚</p>
  </div>
</div>

<div class="input-area">
  <textarea id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1"></textarea>
  <button id="sendBtn">é€ä¿¡</button>
</div>

<script type="module">
// --- State ---
let chatHistory = [];
let isLoading = false;
let memory = localStorage.getItem('cbl_memory') || '';
let turnsSinceLastSummary = 0;
const SUMMARY_INTERVAL = 10; // Summarize every N turns

// --- DOM ---
const apiKeyInput = document.getElementById('apiKey');
const rememberCb = document.getElementById('rememberCb');
const chatArea = document.getElementById('chatArea');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const welcome = document.getElementById('welcome');
const configToggle = document.getElementById('configToggle');
const configPanel = document.getElementById('configPanel');
const systemPrompt = document.getElementById('systemPrompt');
const modelSelect = document.getElementById('modelSelect');
const botTitle = document.getElementById('botTitle');

// --- Init ---
const isRemember = localStorage.getItem('cbl_remember') === '1';
rememberCb.checked = isRemember;
if (isRemember) apiKeyInput.value = localStorage.getItem('cbl_api_key') || '';

// --- Soul loader ---
async function loadSoul() {
  // persona.txt â†’ system prompt
  try {
    const res = await fetch('./soul/persona.txt');
    if (res.ok) {
      const text = await res.text();
      if (text.trim()) systemPrompt.value = text.trim();
    }
  } catch(e) {}

  // config.json â†’ model, title, temperature etc.
  try {
    const res = await fetch('./soul/config.json');
    if (res.ok) {
      const cfg = await res.json();
      if (cfg.model) modelSelect.value = cfg.model;
      if (cfg.title) {
        botTitle.value = cfg.title;
        document.querySelector('.header h1').textContent = 'ğŸ˜ˆ ' + cfg.title;
        document.querySelector('.welcome h2').textContent = 'ğŸ˜ˆ ' + cfg.title;
        document.title = cfg.title;
      }
      if (cfg.welcome) {
        const wp = document.querySelector('.welcome p');
        if (wp) wp.innerHTML = cfg.welcome;
      }
      if (cfg.icon) {
        document.querySelector('.header h1').textContent = cfg.icon + ' ' + (cfg.title || 'ChatBot Lite');
        document.querySelector('.welcome h2').textContent = cfg.icon + ' ' + (cfg.title || 'ChatBot Lite');
      }
      if (cfg.avatar) {
        const img = document.getElementById('welcomeImg');
        if (img) img.src = cfg.avatar;
      }
      if (cfg.subtitle) {
        const ps = document.querySelectorAll('.welcome p');
        if (ps[1]) ps[1].innerHTML = cfg.subtitle;
      }
      // Store for sendMessage
      window._soulConfig = cfg;
    }
  } catch(e) {}

  // memory.txt â†’ initial memory (seed)
  try {
    const res = await fetch('./soul/memory.txt');
    if (res.ok) {
      const text = await res.text();
      if (text.trim() && !memory) memory = text.trim();
    }
  } catch(e) {}

  // knowledge.txt â†’ append to system prompt
  try {
    const res = await fetch('./soul/knowledge.txt');
    if (res.ok) {
      const text = await res.text();
      if (text.trim()) {
        systemPrompt.value += '\n\nã€å‚è€ƒçŸ¥è­˜ã€‘\n' + text.trim();
      }
    }
  } catch(e) {}

  // style.css â†’ inject
  try {
    const res = await fetch('./soul/style.css');
    if (res.ok) {
      const css = await res.text();
      if (css.trim()) {
        const style = document.createElement('style');
        style.textContent = css;
        document.head.appendChild(style);
      }
    }
  } catch(e) {}
}

// Load soul, then apply localStorage overrides
await loadSoul();

// Restore chat history from previous session
const savedHistory = localStorage.getItem('cbl_history');
if (savedHistory) {
  try {
    const parsed = JSON.parse(savedHistory);
    if (Array.isArray(parsed) && parsed.length > 0) {
      chatHistory = parsed;
      // Render previous messages
      welcome.style.display = 'none';
      for (const msg of chatHistory) {
        addMessage(msg.role === 'user' ? 'user' : 'bot', msg.parts[0].text);
      }
      // Show session restore notice
      const notice = document.createElement('div');
      notice.className = 'msg system';
      notice.textContent = 'â€” å‰å›ã®ä¼šè©±ã‚’å¾©å…ƒã—ã¾ã—ãŸ â€”';
      chatArea.appendChild(notice);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
  } catch(e) {}
}

const savedPrompt = localStorage.getItem('cbl_system_prompt');
if (savedPrompt) systemPrompt.value = savedPrompt;

const savedModel = localStorage.getItem('cbl_model');
if (savedModel) modelSelect.value = savedModel;

const savedTitle = localStorage.getItem('cbl_title');
if (savedTitle) {
  botTitle.value = savedTitle;
  document.querySelector('.header h1').textContent = 'ğŸ’¬ ' + savedTitle;
  document.querySelector('.welcome h2').textContent = 'ğŸ’¬ ' + savedTitle;
  document.title = savedTitle;
}

// --- Events ---
document.getElementById('keyVisBtn').addEventListener('click', () => {
  apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
});

sendBtn.addEventListener('click', () => sendMessage());

rememberCb.addEventListener('change', () => {
  if (rememberCb.checked) {
    if (!confirm('âš ï¸ API key will be stored in localStorage.\n\nIt could be accessed by browser extensions or XSS.\nRegenerate at Google AI Studio anytime.\n\nProceed?')) {
      rememberCb.checked = false;
      return;
    }
    localStorage.setItem('cbl_remember', '1');
    localStorage.setItem('cbl_api_key', apiKeyInput.value);
  } else {
    localStorage.setItem('cbl_remember', '0');
    localStorage.removeItem('cbl_api_key');
  }
});

apiKeyInput.addEventListener('change', () => {
  if (rememberCb.checked) localStorage.setItem('cbl_api_key', apiKeyInput.value);
});

systemPrompt.addEventListener('change', () => {
  localStorage.setItem('cbl_system_prompt', systemPrompt.value);
});

modelSelect.addEventListener('change', () => {
  localStorage.setItem('cbl_model', modelSelect.value);
});

botTitle.addEventListener('change', () => {
  const t = botTitle.value.trim() || 'ãƒ¡ãƒ•ã‚£';
  localStorage.setItem('cbl_title', t);
  document.querySelector('.header h1').textContent = 'ğŸ’¬ ' + t;
  document.title = t;
});

configToggle.addEventListener('click', () => {
  configPanel.classList.toggle('active');
  // Show memory preview
  const mp = document.getElementById('memoryPreview');
  mp.textContent = memory ? 'ğŸ’­ Memory: ' + memory : 'ğŸ’­ Memory: (empty)';
});

document.getElementById('clearMemory').addEventListener('click', () => {
  if (!confirm('è¨˜æ†¶ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
  memory = '';
  localStorage.removeItem('cbl_memory');
  document.getElementById('memoryPreview').textContent = 'ğŸ’­ Memory: (empty)';
});

document.getElementById('clearHistory').addEventListener('click', () => {
  if (!confirm('ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
  chatHistory = [];
  localStorage.removeItem('cbl_history');
  turnsSinceLastSummary = 0;
  chatArea.innerHTML = '';
  welcome.style.display = '';
});

userInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
    e.preventDefault();
    sendMessage();
  }
});

userInput.addEventListener('input', () => {
  userInput.style.height = 'auto';
  userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
});

// --- Markdown (lightweight) ---
function renderMarkdown(text) {
  // Simple markdown: bold, italic, code, links, lists, blockquotes
  let html = text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, text, url) => {
      const u = url.toLowerCase().replace(/[\s\u0000-\u001f]/g, '');
      if (u.startsWith('javascript:') || u.startsWith('data:') || u.startsWith('vbscript:')) return text;
      return `<a href="${url}" target="_blank" rel="noopener">${text}</a>`;
    });
  
  // Process line by line for blocks
  const lines = html.split('\n');
  let result = [];
  let inList = false;
  
  for (let line of lines) {
    if (line.match(/^[\s]*[-*]\s/)) {
      if (!inList) { result.push('<ul>'); inList = true; }
      result.push('<li>' + line.replace(/^[\s]*[-*]\s/, '') + '</li>');
    } else if (line.match(/^[\s]*\d+\.\s/)) {
      if (!inList) { result.push('<ol>'); inList = true; }
      result.push('<li>' + line.replace(/^[\s]*\d+\.\s/, '') + '</li>');
    } else {
      if (inList) { result.push('</ul>'); inList = false; }
      if (line.match(/^&gt;\s?/)) {
        result.push('<blockquote>' + line.replace(/^&gt;\s?/, '') + '</blockquote>');
      } else if (line.trim() === '') {
        result.push('<br>');
      } else {
        result.push('<p>' + line + '</p>');
      }
    }
  }
  if (inList) result.push('</ul>');
  
  return result.join('\n');
}

// --- Sanitizer ---
function sanitize(html) {
  const div = document.createElement('div');
  div.innerHTML = html;
  const dangerous = 'script,iframe,object,embed,form,math,svg,base,meta,link,template';
  div.querySelectorAll(dangerous).forEach(el => el.remove());
  div.querySelectorAll('*').forEach(el => {
    for (const attr of [...el.attributes]) {
      const name = attr.name.toLowerCase();
      const val = attr.value.toLowerCase().replace(/[\s\u0000-\u001f]/g, '');
      // Remove event handlers
      if (name.startsWith('on')) { el.removeAttribute(attr.name); continue; }
      // Block dangerous URL schemes
      if (['href', 'src', 'action', 'formaction', 'xlink:href'].includes(name)) {
        if (val.startsWith('javascript:') || val.startsWith('data:') || val.startsWith('vbscript:')) {
          el.removeAttribute(attr.name);
        }
      }
      // Remove style (CSS injection vector)
      if (name === 'style') el.removeAttribute(attr.name);
    }
  });
  return div.innerHTML;
}

// --- Memory ---
function getSystemPromptWithMemory() {
  let prompt = systemPrompt.value;
  if (memory) {
    prompt += '\n\nã€éå»ã®ä¼šè©±ã®è¨˜æ†¶ã€‘\n' + memory;
  }
  return prompt;
}

async function summarizeIfNeeded(key) {
  turnsSinceLastSummary++;
  if (turnsSinceLastSummary < SUMMARY_INTERVAL) return;
  turnsSinceLastSummary = 0;
  
  // Build conversation text for summary
  const recentTurns = chatHistory.slice(-20).map(m => 
    `${m.role === 'user' ? 'User' : 'Bot'}: ${m.parts[0].text}`
  ).join('\n');
  
  const prevMemory = memory ? `Previous memory:\n${memory}\n\n` : '';
  
  try {
    const model = modelSelect.value;
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ role: 'user', parts: [{ text: 
            `${prevMemory}Recent conversation:\n${recentTurns}\n\nSummarize the key facts, user preferences, and important context from this conversation into a concise memory note (max 500 chars). Write in the same language the user used. Only output the summary, nothing else.`
          }]}],
          generationConfig: { temperature: 0.3, maxOutputTokens: 256 }
        })
      }
    );
    if (res.ok) {
      const data = await res.json();
      const summary = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (summary) {
        memory = summary.trim();
        localStorage.setItem('cbl_memory', memory);
      }
    }
  } catch(e) { /* silent fail */ }
}

// --- Chat ---
function addMessage(role, content) {
  if (welcome) welcome.style.display = 'none';
  
  const div = document.createElement('div');
  div.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
  
  if (role === 'user') {
    div.textContent = content;
  } else {
    div.innerHTML = sanitize(renderMarkdown(content));
  }
  
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
  return div;
}

function showTyping() {
  const div = document.createElement('div');
  div.className = 'typing';
  div.id = 'typing';
  div.textContent = 'ã¡ã‚‡ã£ã¨å¾…ã¡ãªã•ã„ã‚ˆ';
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById('typing');
  if (el) el.remove();
}

async function sendMessage() {
  const key = apiKeyInput.value.trim();
  if (!key) { alert('ã¯ãï¼ŸAPIã‚­ãƒ¼ã‚‚å…¥ã‚Œãªã„ã§è©±ã—ã‹ã‘ã¦ãã‚“ã®ï¼Ÿ'); return; }
  
  const text = userInput.value.trim();
  if (!text || isLoading) return;
  
  userInput.value = '';
  userInput.dispatchEvent(new Event('input'));
  userInput.style.height = 'auto';
  isLoading = true;
  sendBtn.disabled = true;
  
  addMessage('user', text);
  chatHistory.push({ role: 'user', parts: [{ text }] });
  // Keep last 50 turns to prevent memory/token explosion
  if (chatHistory.length > 100) chatHistory = chatHistory.slice(-100);
  
  showTyping();
  
  try {
    const model = modelSelect.value;
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system_instruction: { parts: [{ text: getSystemPromptWithMemory() }] },
          contents: chatHistory,
          generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
        })
      }
    );
    
    hideTyping();
    
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      const errCode = err?.error?.code || response.status;
      const errMsg = err?.error?.message || '';
      let friendly;
      if (errCode === 429 || errMsg.includes('quota') || errMsg.includes('rate')) {
        const wait = errMsg.match(/retry in ([\d.]+)s/i);
        friendly = wait
          ? `â³ APIåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚${Math.ceil(parseFloat(wait[1]))}ç§’å¾Œã«ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`
          : 'â³ APIåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚';
      } else if (errCode === 400) {
        friendly = 'âš ï¸ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      } else if (errCode === 403) {
        friendly = 'ğŸ”‘ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚Google AI Studio ã§å†ç™ºè¡Œã—ã¦ãã ã•ã„ã€‚';
      } else if (errCode === 404) {
        friendly = 'âš ï¸ é¸æŠä¸­ã®ãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚Settingsã‹ã‚‰åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
      } else {
        friendly = `âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${errCode})ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚`;
      }
      const errDiv = document.createElement('div');
      errDiv.className = 'msg bot';
      errDiv.textContent = friendly;
      chatArea.appendChild(errDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
      chatHistory.pop();
      return;
    }
    
    const data = await response.json();
    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || '(å¿œç­”ãªã—)';
    
    addMessage('bot', reply);
    chatHistory.push({ role: 'model', parts: [{ text: reply }] });
    
    // Save history & trigger summary
    localStorage.setItem('cbl_history', JSON.stringify(chatHistory.slice(-50)));
    summarizeIfNeeded(key);
    
  } catch (e) {
    hideTyping();
    const errDiv2 = document.createElement('div');
    errDiv2.className = 'msg bot';
    errDiv2.textContent = 'âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    chatArea.appendChild(errDiv2);
    chatArea.scrollTop = chatArea.scrollHeight;
    chatHistory.pop();
  } finally {
    isLoading = false;
    sendBtn.disabled = false;
    userInput.focus();
  }
}
</script>
</body>
</html>
